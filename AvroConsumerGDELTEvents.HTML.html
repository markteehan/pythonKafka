<!DOCTYPE html>
<html>
<head>
    <title>Animated Force Chart</title>
    <script src="d3.min.js"></script>
    <script src="jquery.min.js"></script>
    <style>
        .link {
            stroke: #2E2E2E;
            stroke-width: 2px;
        }

        .node {
            stroke: #fff;
            stroke-width: 2px;
        }
        .textClass {
            stroke: #323232;
            font-family: "Lucida Grande", "Droid Sans", Arial, Helvetica, sans-serif;
            font-weight: normal;
            stroke-width: .5;
            font-size: 10px;
        }
.toolTip {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        position: absolute;
        display: none;
        width: auto;
        height: auto;
        background: none repeat scroll 0 0 white;
        border: 0 none;
        border-radius: 8px 8px 8px 8px;
        box-shadow: -3px 3px 15px #888888;
        color: black;
        font: 12px sans-serif;
        padding: 5px;
        text-align: center;
    }

    </style>
</head>
<body>
<button onclick="addNodes()">Restart Animation</button>
<svg width="960" height="960" font-family="sans-serif" font-size="10" text-anchor="middle"></svg>

<title>Animating Changes in Force Diagram</title>



<script>

base_uri= "http://localhost:8082/consumers/"
console.log("base uri is "+base_uri)
//base_uri= "http://10.0.0.4:8082/consumers/"
//org.apache.kafka.common.config.ConfigException: Invalid value smallest for configuration auto.offset.reset: String must be one of: latest, earliest, none

fetchOnce=0
var step = -1;
AutoOffsetReset="earliest"

//#consumerInstanceName="MyC02"
//#topic="gdeltEvent6"
//#format="avro"

//# Test S03
consumerInstanceName="MyC04"
topic="curlRESTjson"
format="json"
api="v1"


//# Test S04
consumerInstanceName="MyC05"
topic="curlRESTbinary"
format="binary"
api="v1"

//# Test S05
consumerInstanceName="MyC06"
topic="curlRESTavro"
format="avro"
api="v1"

//# Test S05
consumerInstanceName="MyC07"
topic="gdeltEvent6"
topic="gdeltsmall01"
format="avro"
api="v1"




function createConsumerInstance(groupname, pFormat, pApi, callbackfunction) {
  // Consumer Instance not created, create one


  var       vMethod = 'POST'
  var vContent_Type = "application/vnd.kafka."+pApi+"+json"
        var vAccept = ""
           var vUri = base_uri + groupname
          var vData = '{     "format": "'+pFormat+'", "auto.offset.reset": "'+AutoOffsetReset+'","auto.commit.enable":"false"  }'


  console.log("(I) createConsumerInstance: Creating new "+pFormat+" Consumer Instance for "+groupname+" using "+vContent_Type+' and '+vUri+" and " + vData)

  var jqxhr = $.ajax({
           method: vMethod
    ,         url: vUri
    , contentType: vContent_Type
    ,        data: vData
  })
  .done(function(data) {
    console.log("(I) createConsumerInstance: New consumer created:, returned " + data["base_uri"])
    consumerinstance = data["base_uri"]
    // Take the consumer instance out of the URI
    consumerinstancesArray = consumerinstance.split("/")
    consumerinstance = consumerinstancesArray[consumerinstancesArray.length - 1]
    console.log("(I) createConsumerInstance: New consumer parsed " + consumerinstance)
    callbackfunction(consumerinstance, groupname, pFormat, v2_createConsumerSubscription)
  })
  .fail(function(data) {
    console.log("(E) createConsumerInstance: Error creating Consumer Instance:\n")
    console.log("Do a delete here?")
    console.dir(data)
  });
}







function v2_createConsumerSubscription(consumerInstance, groupName, pFormat, callbackfunction) {
  console.log("(I) createConsumerSubscription: Creating new consumer subscription for consumer Instance "+consumerInstance )

  var       vMethod = 'POST'
  var vContent_Type = "application/vnd.kafka.v1+json"
           var vUrl = base_uri + groupName + "/instances/"+consumerInstance+"/subscription/"
           var vData = '{\"topics\":[\"'+topic+'\"]}'

  console.log("(I) createConsumerSubscription: about to call "+vUrl+" for topic "+vData )

  $.ajax({
           method: vMethod
    ,         url: vUrl
    ,        data: "{\"topics\": [\"gdeltEvent6\"]}"
   // ,data:vData
    ,contentType: "application/vnd.kafka.v1+json"
  })
  .done(function(data) {
    console.log("(I) createConsumerSubscription: subscribed consumer subscription using "+base_uri + groupName + "/instances/"+consumerInstance+"/subscription" )
    callbackfunction(consumerInstance, groupName,pFormat,  v2_startConsuming)
  })
  .fail(function(data) {
    console.log("(E) createConsumerSubscription: Error creating Consumer Instance:\n")
    console.dir(data)
  });
}










function v2_startConsuming(consumerInstance, groupName, pFormat, callbackfunction) {
  console.log("(I) startConsuming: Starting callback function startConsuming  for "+groupName)
  //setInterval(function() {
    v2_runConsume(consumerInstance, groupName,pFormat);
    console.log("(I) startConsuming: Finished callback function startConsuming  for "+groupName)
  //}, 5000);
}






function v2_runConsume(consumerInstance, groupName,pFormat) {
     var       vMethod = 'GET'
        //beforeSend: function (xhr){
        //              xhr.setRequestHeader("Content-Type","application/vnd.kafka.avro.v2+json");
        // xhr.setRequestHeader("Accept","application/vnd.kafka.avro.v2+json");

  if (fetchOnce==0) {
      console.log("(I) runConsumer : attempting to consume some data of some size ")
      $.ajax({
                  method: "GET"
               ,dataType:"json"
               ,   async:"false"
               ,     url: base_uri + groupName + "/instances/"+consumerInstance+"/records"
               , headers: {
                               Accept: "application/vnd.kafka."+pFormat+".v2+json"
                          }
      })
      .done(function(data) {
        console.log("(I) runConsume: Consumed some "+pFormat+" data of some size ")
        if (data.length == 0) {
          console.log("NO data returned!")
        }
        if (data.length != 0) {
          var jsonObjects = []
          for(var i = 0; i < data.length; i++) {
            decodedValue = atob(data[i].value)
            var jsonObject = JSON.parse(decodedValue)
            // Add the item count for D3.js to have a single number per row
            jsonObject['itemcount'] = 1
            jsonObjects.push(jsonObject)
          }
          }
      })
      .fail(function(data) {
        console.log("(E) createConsumerSubscription: Error pulling from Consumer Instance:\n")
        console.dir(data)
      });
      fetchOnce=1;
    }
}


function stripString(pString) {
// Convert {"string":"760689192"}   to  760689192
// there must be a better way of doing this
// I'm never going to win software developer of the year with this nonsense
 vString=JSON.stringify(pString)
 return vString
        .replace('{"string":"'  , '')
        .replace('"}'  , '')
}

function v1_getTopicRecords(consumerInstance, groupName, pFormat, callbackfunction) {
  console.log("(I) v1_getTopicRecords: Dequeueing for "+consumerInstance )
  var       vMethod = 'GET'


  if (fetchOnce==0) {
      console.log("(I) v1_getTopicRecords : consuming as application/vnd.kafka."+pFormat+".v1+json from "+base_uri + groupName + "/instances/"+consumerInstance+"/topics/"+topic+"/" )
      $.ajax({
                  method: "GET"
               ,   async:true
               ,crossDomain:true
               ,dataType:'json'
               ,     url: base_uri + groupName + "/instances/"+consumerInstance+"/topics/"+topic+""
               , headers: {
                               Accept: "application/vnd.kafka."+pFormat+".v1+json"
                          }
      })
      .done(function(data) {
        console.log("(I) v1_getTopicRecords: Consumed some "+pFormat+" data of some size ")
        if (data.length == 0) {
          console.log("(I) v1_getTopicRecords: NO data returned!")
        }

        if (data.length != 0) {
          for(var i = 0; i < data.length; i++)
          {
              var jsonObject = data[i]["value"]
              console.log("doing the JSON.parse for "+JSON.stringify(jsonObject))
              if (typeof jsonObject["EventId"] !== 'undefined') {
                // value is {"string":"760689189"}
                console.log("the event id is "+   stripString(jsonObject["EventId"])  )
                console.log("Actor1Name "+   stripString(jsonObject["Actor1Name"])  )
                console.log("Actor2Name "+   stripString(jsonObject["Actor2Name"])  )


              //setTimeout(function() { graph.addNode('UNITED STATES',"#E6E6FA","Environment"); keepNodesOnTop(); }, nextval());

                  if (stripString(jsonObject["Actor1Name"]).length > 0) {
                  setTimeout(function() {
                    graph.addNode(stripString(jsonObject["Actor1Name"]),"#E6E6FA","Global News"   );
                    keepNodesOnTop();
                                      }
                                        , nextval());
                 } else {
                   console.log("Actor1Name is null - no graph update")
                }

                  if (stripString(jsonObject["Actor2Name"]).length > 0) {
                  setTimeout(function() {
                    graph.addNode(stripString(jsonObject["Actor2Name"]),"#E6E6FA","Global News"   );
                    keepNodesOnTop();
                                      }
                                        , nextval());
                 } else {
                   console.log("Actor2Name is null - no graph update")
                }

              }
              else {
                console.log("unable to find the EventID")
              }
          }
        }
      })
      .fail(function(data) {
        console.log("(E) v1_getTopicRecords: Error pulling from Consumer Instance:\n")
        console.dir(data)
      });
      fetchOnce=1;
    }

  }




function nextval()
        {
            step++;
            return 2000 + (500*step); // initial time, wait time
        }

//
// new code
//
    var graph;
    console.log("graph: initializing");


    function myGraph() {
        // Add and remove elements on the graph object
        this.addNode = function (id,color,group) {
            console.log("addNode: adding "+id);
            nodes.push({"id": id,"color": color,"group":group});
            update();
        };

        this.removeNode = function (id) {
            var i = 0;
            var n = findNode(id);
            while (i < links.length) {
                if ((links[i]['source'] == n) || (links[i]['target'] == n)) {
                    links.splice(i, 1);
                }
                else i++;
            }
            nodes.splice(findNodeIndex(id), 1);
            update();
        };

        this.removeLink = function (source, target) {
            for (var i = 0; i < links.length; i++) {
                if (links[i].source.id == source && links[i].target.id == target) {
                    links.splice(i, 1);
                    break;
                }
            }
            update();
        };

        this.removeallLinks = function () {
            links.splice(0, links.length);
            update();
        };

        this.removeAllNodes = function () {
            nodes.splice(0, links.length);
            update();
        };

        this.addLink = function (source, target, value) {
            links.push({"source": findNode(source), "target": findNode(target), "value": value});
            update();
        };

        var findNode = function (id) {
            for (var i in nodes) {
                if (nodes[i]["id"] === id) return nodes[i];
            }
            ;
        };

        var findNodeIndex = function (id) {
            for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].id == id) {
                    return i;
                }
            }
            ;
        };

        // set up the D3 visualisation in the specified element
        var w = 960,
            h = 900;
        var color = d3.scale.category10();
        var vis = d3.select("body")
                .append("svg:svg")
                .attr("width", w)
                .attr("height", h)
                .attr("id", "svg")
                .attr("pointer-events", "all")
                .attr("viewBox", "0 0 " + w + " " + h)
                .attr("perserveAspectRatio", "xMinYMid")
                .append('svg:g');

        var div = d3.select("body").append("div").attr("class", "toolTip");
        var force = d3.layout.force();

        var nodes = force.nodes(),
        links = force.links();

        var update = function () {
            var link = vis.selectAll("line")
                    .data(links, function (d) {
                        return d.source.id + "-" + d.target.id;
                    });

            link.enter().append("line")
                    .attr("id", function (d) {
                        return d.source.id + "-" + d.target.id;
                    })
                    .attr("stroke-width", function (d) {
                        return d.value / 10;
                    })
                    .attr("class", "link");
            link.append("title")
                    .text(function (d) {
                        return d.value;
                    });
            link.exit().remove();

            var node = vis.selectAll("g.node")
                    .data(nodes, function (d) {
                        return d.id;
                    });

            node.on("mousemove", function(d){
                div.style("left", d3.event.pageX+10+"px");
                div.style("top", d3.event.pageY-25+"px");
                div.style("display", "inline-block");
                div.html((d.group)+"<br>"+(d.group)+"%");
            });

            node.on("mouseout", function(d){
                div.style("display", "none");
            });


//       var label = node.append("text")
//         .attr("dy", ".35em")
//         .text(function(d) { return d.group; });

            var nodeEnter = node.enter().append("g")
                    .attr("class", "node")
                    .call(force.drag);

            nodeEnter.append("svg:circle")
                    .attr("r", 12)
                    .attr("id", function (d) {
                        return "Node;" + d.id;
                    })
                    .attr("class", "nodeStrokeClass")
//                    .attr("fill", function(d) { return color(d.id); });
                    .attr("fill", function(d) { return d.color });

            nodeEnter.append("svg:text")
                    .attr("class", "textClass")
                    .attr("x", 14)
                    .attr("y", ".31em")
                    .text(function (d) {
                        return d.id;
                    });

            node.exit().remove();

            force.on("tick", function () {
                node.attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; });

                link.attr("x1", function (d) { return d.source.x; })
                        .attr("y1", function (d) {
                            return d.source.y;
                        })
                        .attr("x2", function (d) {
                            return d.target.x;
                        })
                        .attr("y2", function (d) {
                            return d.target.y;
                        });
                //label
                //  .attr("x", function(d) { return d.x + 8; })
                //  .attr("y", function(d) { return d.y; });

            });

            // Restart the force layout.
            force
                    .gravity(.001)
                    .charge(-80000)
                    .friction(0.001)
                    //.linkDistance( function(d) { return d.value * 10 } )
                    .linkDistance(300)
                    .size([w, h])
                    .start();
        };


        // Make it all go
        update();
    }



    function drawGraph() {
        graph = new myGraph("#svgdiv");
        keepNodesOnTop();
        // callback for the changes in the network

        //setTimeout(function() { graph.addNode('COMPANIES',"#1E90FF","Business"); keepNodesOnTop(); }, nextval());
        //setTimeout(function() { graph.addNode('KING',"#1E90FF","Government"); keepNodesOnTop(); }, nextval());
        //setTimeout(function() { graph.addLink('COMPANIES','KING',11); keepNodesOnTop(); }, nextval());
        //setTimeout(function() { graph.addNode('UNITED STATES',"#1E90FF","Government"); keepNodesOnTop(); }, nextval());
        //setTimeout(function() { graph.addLink('COMPANIES','UNITED STATES',11); keepNodesOnTop(); }, nextval());
        //setTimeout(function() { graph.addNode('SCIENTIST',"#E6E6FA","Civilian"); keepNodesOnTop(); }, nextval());
        //setTimeout(function() { graph.addNode('UNITED STATES',"#E6E6FA","Environment"); keepNodesOnTop(); }, nextval());
 }

    //
    // starts here
    //
    console.log("running drawGraph")
    drawGraph();
    console.log("step 1: create Consumer Instance  "+consumerInstanceName+" format "+format)

    // Confluent rest-api stuff
    if (api == "v1") {
    AutoOffsetReset="smallest";  //v1="smallest", v2="earliest"
    createConsumerInstance(consumerInstanceName,format, api, v1_getTopicRecords)
    }
    else {
      createConsumerInstance(consumerInstanceName,format, api, v2_createConsumerSubscription)
    }


    // because of the way the network is created, nodes are created first, and links second,
    // so the lines were on top of the nodes, this just reorders the DOM to put the svg:g on top
    function keepNodesOnTop() {
        $(".nodeStrokeClass").each(function( index ) {
            var gnode = this.parentNode;
            gnode.parentNode.appendChild(gnode);
        });
    }
    function addNodes() {
        d3.select("svg")
                .remove();
         drawGraph();
    }
//
// end of new code
//

</script>
</body>
</html>
