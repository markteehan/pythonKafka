<!DOCTYPE html>
<svg width="960" height="960" font-family="sans-serif" font-size="10" text-anchor="middle"></svg>
<script src="jquery.min.js"></script>



<script>

base_uri= "http://localhost:8082/consumers/"
console.log("base uri is "+base_uri)
//base_uri= "http://10.0.0.4:8082/consumers/"
//org.apache.kafka.common.config.ConfigException: Invalid value smallest for configuration auto.offset.reset: String must be one of: latest, earliest, none

fetchOnce=0
AutoOffsetReset="earliest"

//#consumerInstanceName="MyC02"
//#topic="gdeltEvent6"
//#format="avro"

//# Test S03
consumerInstanceName="MyC04"
topic="curlRESTjson"
format="json"
api="v1"


//# Test S04
consumerInstanceName="MyC05"
topic="curlRESTbinary"
format="binary"
api="v1"

//# Test S05
consumerInstanceName="MyC06"
topic="curlRESTavro"
format="avro"
api="v1"

//# Test S05
consumerInstanceName="MyC07"
topic="gdeltEvent6"
topic="gdeltsmall01"
format="avro"
api="v1"




function createConsumerInstance(groupname, pFormat, pApi, callbackfunction) {
  // Consumer Instance not created, create one


  var       vMethod = 'POST'
  var vContent_Type = "application/vnd.kafka."+pApi+"+json"
        var vAccept = ""
           var vUri = base_uri + groupname
          var vData = '{     "format": "'+pFormat+'", "auto.offset.reset": "'+AutoOffsetReset+'","auto.commit.enable":"false"  }'


  console.log("(I) createConsumerInstance: Creating new "+pFormat+" Consumer Instance for "+groupname+" using "+vContent_Type+' and '+vUri+" and " + vData)

  var jqxhr = $.ajax({
           method: vMethod
    ,         url: vUri
    , contentType: vContent_Type
    ,        data: vData
  })
  .done(function(data) {
    console.log("(I) createConsumerInstance: New consumer created:, returned " + data["base_uri"])
    consumerinstance = data["base_uri"]
    // Take the consumer instance out of the URI
    consumerinstancesArray = consumerinstance.split("/")
    consumerinstance = consumerinstancesArray[consumerinstancesArray.length - 1]
    console.log("(I) createConsumerInstance: New consumer parsed " + consumerinstance)
    callbackfunction(consumerinstance, groupname, pFormat, v2_createConsumerSubscription)
  })
  .fail(function(data) {
    console.log("(E) createConsumerInstance: Error creating Consumer Instance:\n")
    console.log("Do a delete here?")
    console.dir(data)
  });
}







function v2_createConsumerSubscription(consumerInstance, groupName, pFormat, callbackfunction) {
  console.log("(I) createConsumerSubscription: Creating new consumer subscription for consumer Instance "+consumerInstance )

  var       vMethod = 'POST'
  var vContent_Type = "application/vnd.kafka.v1+json"
           var vUrl = base_uri + groupName + "/instances/"+consumerInstance+"/subscription/"
           var vData = '{\"topics\":[\"'+topic+'\"]}'

  console.log("(I) createConsumerSubscription: about to call "+vUrl+" for topic "+vData )

  $.ajax({
           method: vMethod
    ,         url: vUrl
    ,        data: "{\"topics\": [\"gdeltEvent6\"]}"
   // ,data:vData
    ,contentType: "application/vnd.kafka.v1+json"
  })
  .done(function(data) {
    console.log("(I) createConsumerSubscription: subscribed consumer subscription using "+base_uri + groupName + "/instances/"+consumerInstance+"/subscription" )
    callbackfunction(consumerInstance, groupName,pFormat,  v2_startConsuming)
  })
  .fail(function(data) {
    console.log("(E) createConsumerSubscription: Error creating Consumer Instance:\n")
    console.dir(data)
  });
}










function v2_startConsuming(consumerInstance, groupName, pFormat, callbackfunction) {
  console.log("(I) startConsuming: Starting callback function startConsuming  for "+groupName)
  //setInterval(function() {
    v2_runConsume(consumerInstance, groupName,pFormat);
    console.log("(I) startConsuming: Finished callback function startConsuming  for "+groupName)
  //}, 5000);
}






function v2_runConsume(consumerInstance, groupName,pFormat) {
     var       vMethod = 'GET'
        //beforeSend: function (xhr){
        //              xhr.setRequestHeader("Content-Type","application/vnd.kafka.avro.v2+json");
        // xhr.setRequestHeader("Accept","application/vnd.kafka.avro.v2+json");

  if (fetchOnce==0) {
      console.log("(I) runConsumer : attempting to consume some data of some size ")
      $.ajax({
                  method: "GET"
               ,dataType:"json"
               ,   async:"false"
               ,     url: base_uri + groupName + "/instances/"+consumerInstance+"/records"
               , headers: {
                               Accept: "application/vnd.kafka."+pFormat+".v2+json"
                          }
      })
      .done(function(data) {
        console.log("(I) runConsume: Consumed some "+pFormat+" data of some size ")
        if (data.length == 0) {
          console.log("NO data returned!")
        }
        if (data.length != 0) {
          var jsonObjects = []
          for(var i = 0; i < data.length; i++) {
            decodedValue = atob(data[i].value)
            var jsonObject = JSON.parse(decodedValue)
            // Add the item count for D3.js to have a single number per row
            jsonObject['itemcount'] = 1
            jsonObjects.push(jsonObject)
          }
          }
      })
      .fail(function(data) {
        console.log("(E) createConsumerSubscription: Error pulling from Consumer Instance:\n")
        console.dir(data)
      });
      fetchOnce=1;
    }
}


function stripString(pString) {
// Convert {"string":"760689192"}   to  760689192
// there must be a better way of doing this
// I'm never going to win software developer of the year with this nonsense
 vString=JSON.stringify(pString)
 return vString
        .replace('{"string":"'  , '')
        .replace('"}'  , '')
}

function v1_getTopicRecords(consumerInstance, groupName, pFormat, callbackfunction) {
  console.log("(I) v1_getTopicRecords: Dequeueing for "+consumerInstance )
  var       vMethod = 'GET'


  if (fetchOnce==0) {
      console.log("(I) v1_getTopicRecords : consuming as application/vnd.kafka."+pFormat+".v1+json from "+base_uri + groupName + "/instances/"+consumerInstance+"/topics/"+topic+"/" )
      $.ajax({
                  method: "GET"
               ,   async:true
               ,crossDomain:true
               ,dataType:'json'
               ,     url: base_uri + groupName + "/instances/"+consumerInstance+"/topics/"+topic+""
               , headers: {
                               Accept: "application/vnd.kafka."+pFormat+".v1+json"
                          }
      })
      .done(function(data) {
        console.log("(I) v1_getTopicRecords: Consumed some "+pFormat+" data of some size ")
        if (data.length == 0) {
          console.log("(I) v1_getTopicRecords: NO data returned!")
        }

        if (data.length != 0) {
          for(var i = 0; i < data.length; i++)
          {
              var jsonObject = data[i]["value"]

              console.log("doing the JSON.parse for "+JSON.stringify(jsonObject))

              if (typeof jsonObject["EventId"] !== 'undefined') {
                // value is {"string":"760689189"}
                console.log("the event id is "+   stripString(jsonObject["EventId"])  )
                console.log("Actor1Name "+   stripString(jsonObject["Actor1Name"])  )
                console.log("Actor2Name "+   stripString(jsonObject["Actor2Name"])  )
              }
              else {
                console.log("unable to find the EventID")
              }
          }
        }
      })
      .fail(function(data) {
        console.log("(E) v1_getTopicRecords: Error pulling from Consumer Instance:\n")
        console.dir(data)
      });
      fetchOnce=1;
    }

  }



console.log("step 1: create Consumer Instance  "+consumerInstanceName+" format "+format)
if (api == "v1") {
    AutoOffsetReset="smallest";  //v1="smallest", v2="earliest"
    createConsumerInstance(consumerInstanceName,format, api, v1_getTopicRecords)
    }
    else {
      createConsumerInstance(consumerInstanceName,format, api, v2_createConsumerSubscription)
    }

</script>
