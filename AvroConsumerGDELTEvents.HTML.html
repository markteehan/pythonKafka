<!DOCTYPE html>
<svg width="960" height="960" font-family="sans-serif" font-size="10" text-anchor="middle"></svg>
<script src="jquery.min.js"></script>



<script>

base_uri= "http://localhost:8082/consumers/"
console.log("base uri is "+base_uri)
//base_uri= "http://10.0.0.4:8082/consumers/"
topic="gdeltEvent6"
//org.apache.kafka.common.config.ConfigException: Invalid value smallest for configuration auto.offset.reset: String must be one of: latest, earliest, none
AutoOffsetReset="earliest"
fetchOnce=0
consumerInstanceName="MyC02"


function createConsumerInstanceAvro(groupname, callbackfunction) {
  // Consumer Instance not created, create one

  var       vMethod = 'POST'
  var vContent_Type = "application/vnd.kafka.v2+json"
        var vAccept = ""
           var vUri = base_uri + groupname
          var vData = '{     "format": "avro", "auto.offset.reset": "'+AutoOffsetReset+'","auto.commit.enable":"false"  }'

  console.log("(I) createConsumerInstanceAvro: Creating new Consumer Instance for "+groupname+" using "+vUri+" and " + vData)

  var jqxhr = $.ajax({
           method: vMethod
    ,         url: vUri
    , contentType: vContent_Type
    ,        data: vData
  })
  .done(function(data) {
    console.log("(I) createConsumerInstanceAvro: New consumer created:, returned " + data["base_uri"])
    consumerinstance = data["base_uri"]
    // Take the consumer instance out of the URI
    consumerinstancesArray = consumerinstance.split("/")
    consumerinstance = consumerinstancesArray[consumerinstancesArray.length - 1]
    console.log("(I) createConsumerInstanceAvro: New consumer parsed " + consumerinstance)
    callbackfunction(consumerinstance, groupname, createConsumerSubscriptionAvro)
  })
  .fail(function(data) {
    console.log("(E) createConsumerInstanceAvro: Error creating Consumer Instance:\n")
    console.log("Do a delete here?")
    console.dir(data)
  });
}








function createConsumerSubscriptionAvro(consumerInstance, groupName, callbackfunction) {
  console.log("(I) createConsumerSubscriptionAvro: Creating new consumer subscription for consumer Instance "+consumerInstance )

  var       vMethod = 'POST'
  var       vType = 'POST'
  var vContent_Type = "application/vnd.kafka.v2+json"
        var vAccept = ""
           var vUrl = base_uri + groupName + "/instances/"+consumerInstance+"/subscription/"
           var vData = '{\"topics\":[\"'+topic+'\"]}'
               //, contentType: vContent_Type
  console.log("(I) createConsumerSubscriptionAvro: about to call "+vUrl+" for topic "+vData )

  // Create consumer instance
  //var jqxhr = $.ajax({
  //  type: "POST",
  //  data: "{\"format\": \"binary\"}",
  //  url:base_uri + groupname,
  //  contentType: "application/vnd.kafka.v1+json"
  //})


  var jqxhr = $.ajax({
             type: vType
    ,         url: vUrl
    ,data: "{\"topics\": [\"gdeltEvent6\"]}"
   // ,data:vData
    ,contentType: "application/vnd.kafka.v2+json"
  })
  .done(function(data) {
    console.log("(I) createConsumerSubscriptionAvro: subscribed consumer subscription using "+base_uri + groupName + "/instances/"+consumerInstance+"/subscription" )
    callbackfunction(consumerInstance, groupName, startConsuming)
  })
  .fail(function(data) {
    console.log("(E) createConsumerSubscriptionAvro: Error creating Consumer Instance:\n")
    console.dir(data)
  });
}










function startConsuming(consumerInstance, groupName, callbackfunction) {
  console.log("(I) startConsuming: Starting callback function startConsuming  for "+groupName)
  //setInterval(function() {
    runConsume(consumerInstance, groupName);
    console.log("(I) startConsuming: Finished callback function startConsuming  for "+groupName)
  //}, 5000);
}












function runConsume(consumerInstance, groupName) {
     var       vMethod = 'GET'
        //beforeSend: function (xhr){
        //              xhr.setRequestHeader("Content-Type","application/vnd.kafka.avro.v2+json");
        // xhr.setRequestHeader("Accept","application/vnd.kafka.avro.v2+json");

  if (fetchOnce==0) {
      console.log("(I) runConsumer : attempting to consume some data of some size ")
      var jqxhr = $.ajax({
               type: "GET"
               ,url: base_uri + groupName + "/instances/"+consumerInstance+"/records"
               ,headers: {
                               Accept: "application/vnd.kafka.avro.v2+json"
                        //, ContentType: "application/vnd.kafka.avro.v2+json"
                         }
      })
      .done(function(data) {
        console.log("(I) runConsume: Consumed some data of some size ")
        //console.log("Consumed ");
        console.dir(data)
        if (data.length == 0) {
          console.log("NO data returned!")
        }
        if (data.length != 0) {
          var jsonObjects = []
          for(var i = 0; i < data.length; i++) {
            decodedValue = atob(data[i].value)
            var jsonObject = JSON.parse(decodedValue)
            // Add the item count for D3.js to have a single number per row
            jsonObject['itemcount'] = 1
            jsonObjects.push(jsonObject)
          }
          }
      })
      .fail(function(data) {
        console.log("(E) createConsumerSubscriptionAvro: Error pulling from Consumer Instance:\n")
        console.dir(data)
      });
      fetchOnce=1;
    }
}

console.log("step 1: create Consumer Instance for my_consumer_instance")
createConsumerInstanceAvro(consumerInstanceName, createConsumerSubscriptionAvro)

</script>
